<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard G√©n√©ral</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card-header { font-weight: bold; font-size: 1.2rem; }
        .badge-role { font-size: 0.9rem; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Dashboard</a>
        <button class="btn btn-outline-light ms-auto" id="logoutBtn">Se d√©connecter</button>
    </div>
</nav>

<div class="container my-5">
    <div class="text-center mb-4">
        <h1 id="welcomeMsg">Bienvenue</h1>
        <p id="roleMsg">Vous √™tes connect√©(e).</p>
    </div>

    <!-- Sections -->
    <div id="adminSection" class="d-none">
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white">Liste des Utilisateurs</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle mb-0" id="usersTable">
                        <thead class="table-light">
                        <tr><th>ID</th><th>Nom</th><th>Email</th><th>R√¥le</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="agriculteurSection" class="d-none">
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-success text-white">Liste des Produits</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" id="produitsTable">
                        <thead class="table-light">
                        <tr><th>ID</th><th>Nom</th><th>Prix (FCFA)</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="acheteurSection" class="d-none">
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-info text-white">Liste des Commandes</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" id="commandesTable">
                        <thead class="table-light">
                        <tr><th>ID</th><th>Produit</th><th>Quantit√©</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="decideurSection" class="d-none">
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-warning text-dark">Liste des Alertes</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" id="alertesTable">
                        <thead class="table-light">
                        <tr><th>ID</th><th>Message</th><th>Date</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE = "http://localhost:8086/api";
    const token = localStorage.getItem("token");
    const role = localStorage.getItem("role");

    if (!token || !role) {
        alert("Veuillez vous connecter !");
        window.location.href = "login.html";
    }

    const welcomeMsg = document.getElementById("welcomeMsg");
    const roleMsg = document.getElementById("roleMsg");

    function badgeClass(r) {
        switch(r) {
            case "ADMIN": return "badge bg-danger badge-role";
            case "AGRICULTEUR": return "badge bg-success badge-role";
            case "ACHETEUR": return "badge bg-primary badge-role";
            case "DECIDEUR": return "badge bg-warning text-dark badge-role";
            default: return "badge bg-secondary badge-role";
        }
    }

    switch(role) {
        case "ADMIN":
            welcomeMsg.textContent = "Bienvenue ADMIN üöÄ";
            roleMsg.textContent = "G√©rez les utilisateurs et ressources.";
            document.getElementById("adminSection").classList.remove("d-none");
            loadUsers();
            break;
        case "AGRICULTEUR":
            welcomeMsg.textContent = "Bienvenue AGRICULTEUR üå±";
            roleMsg.textContent = "G√©rez vos produits et alertes agricoles.";
            document.getElementById("agriculteurSection").classList.remove("d-none");
            loadProduits();
            break;
        case "ACHETEUR":
            welcomeMsg.textContent = "Bienvenue ACHETEUR üõí";
            roleMsg.textContent = "Consultez les produits et vos commandes.";
            document.getElementById("acheteurSection").classList.remove("d-none");
            loadCommandes();
            break;
        case "DECIDEUR":
            welcomeMsg.textContent = "Bienvenue DECIDEUR üìä";
            roleMsg.textContent = "Analysez les alertes et rapports agricoles.";
            document.getElementById("decideurSection").classList.remove("d-none");
            loadAlertes();
            break;
        default:
            alert("R√¥le inconnu !");
            localStorage.clear();
            window.location.href = "login.html";
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.clear();
        window.location.href = "login.html";
    });

    async function fetchWithJWT(url) {
        const res = await fetch(url, { headers: { "Authorization": "Bearer " + token } });
        if (!res.ok) throw new Error("Erreur HTTP " + res.status);
        return res.json();
    }

    async function loadUsers() {
        try {
            const users = await fetchWithJWT(`${API_BASE}/utilisateurs`);
            const tbody = document.querySelector("#usersTable tbody");
            tbody.innerHTML = "";
            users.forEach(u => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${u.id}</td><td>${u.nom}</td><td>${u.email}</td><td><span class="${badgeClass(u.role)}">${u.role}</span></td>`;
                tbody.appendChild(tr);
            });
        } catch(err){ console.error(err); }
    }

    async function loadProduits() {
        try {
            const produits = await fetchWithJWT(`${API_BASE}/produits`);
            const tbody = document.querySelector("#produitsTable tbody");
            tbody.innerHTML = "";
            produits.forEach(p => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${p.id}</td><td>${p.nom}</td><td>${p.prix}</td>`;
                tbody.appendChild(tr);
            });
        } catch(err){ console.error(err); }
    }

    async function loadCommandes() {
        try {
            const commandes = await fetchWithJWT(`${API_BASE}/commandes`);
            const tbody = document.querySelector("#commandesTable tbody");
            tbody.innerHTML = "";
            commandes.forEach(c => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${c.id}</td><td>${c.produit.nom}</td><td>${c.quantite}</td>`;
                tbody.appendChild(tr);
            });
        } catch(err){ console.error(err); }
    }

    async function loadAlertes() {
        try {
            const alertes = await fetchWithJWT(`${API_BASE}/alertes`);
            const tbody = document.querySelector("#alertesTable tbody");
            tbody.innerHTML = "";
            alertes.forEach(a => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${a.id}</td><td>${a.message}</td><td>${new Date(a.date).toLocaleString()}</td>`;
                tbody.appendChild(tr);
            });
        } catch(err){ console.error(err); }
    }
</script>
</body>
</html>
