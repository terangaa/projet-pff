<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard DÃ©cideur - Statistiques (Cyber Vert)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* Background dark mode */
        body {
            background: linear-gradient(135deg, #0a1a0a, #002200);
            color: #aaffaa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        nav.navbar {
            background-color: #001100;
            box-shadow: 0 0 20px #00ff66;
        }
        nav.navbar a.navbar-brand {
            color: #00ff66;
            font-weight: 700;
            text-shadow: 0 0 10px #00ff66;
        }

        /* Stat cards */
        .card-stat {
            border-radius: 25px;
            background-color: #001100;
            box-shadow: 0 0 15px #00ff66;
            transition: transform 0.4s, box-shadow 0.4s;
        }
        .card-stat:hover {
            transform: translateY(-12px);
            box-shadow: 0 0 30px #00ff66;
        }

        .stat-icon {
            font-size: 3rem;
            padding: 20px;
            border-radius: 50%;
            display: inline-block;
            color: #001100;
            background-color: #00ff66;
            box-shadow: 0 0 15px #00ff66;
        }

        .counter {
            font-size: 2.5rem;
            font-weight: 700;
            color: #00ff66;
            text-shadow: 0 0 10px #00ff66;
        }

        h2 {
            font-weight: 700;
            color: #00ff66;
            text-shadow: 0 0 15px #00ff66;
        }

        .btn-secondary {
            background-color: #004400;
            border: none;
            color: #00ff66;
            text-shadow: 0 0 5px #00ff66;
        }
        .btn-secondary:hover {
            background-color: #006600;
            box-shadow: 0 0 10px #00ff66;
        }

        /* Chart container */
        .chart-container {
            background-color: #001100;
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 0 25px #00ff66;
        }

        /* Glow animation */
        .counter-glow {
            animation: glow 1.5s ease-in-out infinite alternate;
        }
        @keyframes glow {
            0% { text-shadow: 0 0 5px #00ff66; }
            100% { text-shadow: 0 0 20px #00ff66; }
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="#">Espace DÃ©cideur</a>
        <div class="d-flex align-items-center">
            <span class="text-white me-3">ConnectÃ© : <b th:text="${email}"></b></span>
            <a href="/auth/logout" class="btn btn-outline-light btn-sm">DÃ©connexion</a>
        </div>
    </div>
</nav>

<div class="container mt-5">
    <h2 class="mb-5 text-center">ðŸ“Š Statistiques globales</h2>

    <!-- Cartes de stats -->
    <div class="row g-4 mb-5 text-center">
        <div class="col-md-3">
            <div class="card card-stat p-4 shadow-sm">
                <div class="stat-icon"><i class="bi bi-shield-lock-fill"></i></div>
                <h5 class="mt-2">Administrateurs</h5>
                <div id="nbAdmin" class="counter counter-glow">0</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-stat p-4 shadow-sm">
                <div class="stat-icon"><i class="bi bi-tree-fill"></i></div>
                <h5 class="mt-2">Agriculteurs</h5>
                <div id="nbAgriculteur" class="counter counter-glow">0</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-stat p-4 shadow-sm">
                <div class="stat-icon"><i class="bi bi-cart-fill"></i></div>
                <h5 class="mt-2">Acheteurs</h5>
                <div id="nbAcheteur" class="counter counter-glow">0</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-stat p-4 shadow-sm">
                <div class="stat-icon"><i class="bi bi-people-fill"></i></div>
                <h5 class="mt-2">Total utilisateurs</h5>
                <div id="totalUsers" class="counter counter-glow">0</div>
            </div>
        </div>
    </div>

    <!-- Graphique circulaire -->
    <div class="chart-container mb-5">
        <canvas id="pieChart"></canvas>
    </div>

    <div class="text-center mb-5">
        <a href="/decideur/dashboard" class="btn btn-secondary btn-lg">Retour au tableau de bord</a>
    </div>
</div>

<script>
    const ctx = document.getElementById('pieChart').getContext('2d');
    const pieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Admins', 'Agriculteurs', 'Acheteurs'],
            datasets: [{
                label: 'RÃ©partition des utilisateurs',
                data: [0, 0, 0],
                backgroundColor: ['#00ff66', '#00cc44', '#ffaa00'],
                borderColor: '#001100',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        pointStyle: 'circle',
                        color: '#00ff66'
                    }
                },
                title: {
                    display: true,
                    text: 'RÃ©partition des utilisateurs par rÃ´le',
                    font: { size: 22, weight: '700' },
                    color: '#00ff66'
                }
            }
        }
    });

    function animateCounter(element, value) {
        let start = parseInt(element.innerText);
        const increment = (value - start) / 60;
        let current = start;
        const step = () => {
            current += increment;
            if ((increment > 0 && current >= value) || (increment < 0 && current <= value)) {
                element.innerText = value;
            } else {
                element.innerText = Math.floor(current);
                requestAnimationFrame(step);
            }
        };
        step();
    }

    function updateStats() {
        fetch('/api/statistiques')
            .then(res => res.json())
            .then(data => {
                animateCounter(document.getElementById('nbAdmin'), data.nbAdmin);
                animateCounter(document.getElementById('nbAgriculteur'), data.nbAgriculteur);
                animateCounter(document.getElementById('nbAcheteur'), data.nbAcheteur);
                animateCounter(document.getElementById('totalUsers'), data.totalUsers);

                pieChart.data.datasets[0].data = [
                    data.nbAdmin,
                    data.nbAgriculteur,
                    data.nbAcheteur
                ];
                pieChart.update();
            });
    }

    setInterval(updateStats, 5000);
    updateStats();
</script>

</body>
</html>
