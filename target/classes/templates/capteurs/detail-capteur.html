<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Détail Capteur - PAGAM</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f4f6f9;
            font-family: "Segoe UI", sans-serif;
        }
        .card {
            border-radius: 1rem;
            background: #fff;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            position: relative;
            transition: background 0.5s;
        }
        .badge-type {
            padding: 0.45em 0.85em;
            font-size: 0.85em;
            font-weight: 600;
            color: #fff;
            border-radius: 1rem;
            transition: all 0.3s;
        }
        .bg-temp {
            background: linear-gradient(135deg, #f87171, #dc3545);
        }
        .bg-humidite {
            background: linear-gradient(135deg, #3b82f6, #0d6efd);
        }
        .bg-sol {
            background: linear-gradient(135deg, #34d399, #198754);
        }
        .bg-default {
            background: linear-gradient(135deg, #9ca3af, #6c757d);
        }
        .blink {
            animation: blink-animation 0.8s infinite;
        }
        @keyframes blink-animation {
            0%,
            100% {
                opacity: 1;
            }
            50% {
                opacity: 0.3;
            }
        }
    </style>
</head>
<body>
<div class="container py-5">
    <div class="mb-4">
        <a th:href="@{/capteurs}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Retour
        </a>
    </div>

    <div id="capteurCard" class="card">
        <div class="text-center mb-4">
            <i
                    class="fs-1 mb-3 text-success"
                    th:classappend="${capteur.iconClass}"
            ></i>
            <h3>
                <span th:text="${capteur.nom}">Nom Capteur</span>
                (<span th:text="${capteur.reference}">REF</span>)
            </h3>
            <p class="text-muted mb-1">
                <i class="fas fa-map-marker-alt text-success"></i>
                <span th:text="${capteur.localisation}">Localisation</span>
            </p>
            <span
                    id="badgeType"
                    class="badge-type"
                    th:classappend="${capteur.type == 'TEMP' ? ' bg-temp' :
                                   (capteur.type == 'HUMIDITE' ? ' bg-humidite' :
                                   (capteur.type == 'SOL' ? ' bg-sol' : ' bg-default'))}"
                    th:text="${capteur.type}"
            >Type</span
            >
            <p class="mt-3">
                Moyenne :
                <strong
                        id="moyenneSpan"
                        th:text="${moyenne != null ? moyenne : 'N/A'}"
                ></strong>
            </p>
        </div>

        <div class="mt-4">
            <canvas id="mesureChart"></canvas>
        </div>

        <div class="mt-4">
            <h5>Dernières mesures</h5>
            <table class="table table-striped">
                <thead>
                <tr>
                    <th>Date</th>
                    <th>Valeur</th>
                </tr>
                </thead>
                <tbody id="mesureTable">
                <tr th:each="m : ${mesures}">
                    <td th:text="${#temporals.format(m.date, 'dd/MM/yyyy HH:mm')}">
                        01/01/2025
                    </td>
                    <td th:text="${m.valeur}">0.0</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Son d'alerte -->
<audio
        id="alertSound"
        src="https://www.soundjay.com/button/sounds/beep-07.mp3"
        preload="auto"
></audio>

<script th:inline="javascript">
    /*<![CDATA[*/
    const mesures = /*[[${mesures}]]*/ [];
    const capteurType = /*[[${capteur.type}]]*/ "TEMP";
    const badge = document.getElementById("badgeType");
    const card = document.getElementById("capteurCard");
    const moyenneSpan = document.getElementById("moyenneSpan");
    const mesureTable = document.getElementById("mesureTable");
    const alertSound = document.getElementById("alertSound");
    const seuil = 35; // seuil d'alerte

    // Préparer le graphique
    const ctx = document.getElementById("mesureChart").getContext("2d");
    const labels = mesures.map((m) => m.date.substring(11, 16));
    const valeurs = mesures.map((m) => m.valeur);
    const chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: labels,
            datasets: [
                {
                    label: "Mesures",
                    data: valeurs,
                    fill: true,
                    borderColor: "rgba(13,110,253,1)",
                    backgroundColor: "rgba(13,110,253,0.1)",
                    tension: 0.4,
                },
            ],
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
        },
    });

    // Mettre à jour la moyenne initiale
    if (valeurs.length > 0) {
        const avg = valeurs.reduce((a, b) => a + b, 0) / valeurs.length;
        moyenneSpan.textContent = avg.toFixed(1);
    }

    // Simulation / actualisation des mesures
    setInterval(() => {
        const now = new Date();
        const time =
            now.getHours().toString().padStart(2, "0") +
            ":" +
            now.getMinutes().toString().padStart(2, "0");
        const valeur = Math.random() * 50; // remplacer par vraie mesure

        // graphique
        chart.data.labels.push(time);
        chart.data.datasets[0].data.push(valeur);
        if (chart.data.labels.length > 10) {
            chart.data.labels.shift();
            chart.data.datasets[0].data.shift();
        }
        chart.update();

        // table
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${time}</td><td>${valeur.toFixed(1)}</td>`;
        if (mesureTable.children.length >= 10)
            mesureTable.removeChild(mesureTable.children[0]);
        mesureTable.appendChild(tr);

        // moyenne
        const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
        moyenneSpan.textContent = (
            total / chart.data.datasets[0].data.length
        ).toFixed(1);

        // alerte
        if (valeur > seuil) {
            badge.classList.add("bg-danger", "blink");
            badge.classList.remove(
                "bg-temp",
                "bg-humidite",
                "bg-sol",
                "bg-default"
            );
            badge.textContent = "ALERTE !";
            card.style.background = "linear-gradient(145deg,#ffe5e5,#ffcccc)";
            alertSound.play();
        } else {
            badge.classList.remove("bg-danger", "blink");
            card.style.background = "#fff";
            // remettre badge normal selon type
            if (capteurType === "TEMP") {
                badge.classList.add("bg-temp");
                badge.textContent = "TEMP";
            } else if (capteurType === "HUMIDITE") {
                badge.classList.add("bg-humidite");
                badge.textContent = "HUMIDITE";
            } else if (capteurType === "SOL") {
                badge.classList.add("bg-sol");
                badge.textContent = "SOL";
            } else {
                badge.classList.add("bg-default");
                badge.textContent = "N/A";
            }
        }
    }, 3000);
    /*]]>*/
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
